###################################  macros  #######################################
##
###generate key
#macro( getKey )##
#if($policy.getPolicyLevel() == "app")
str:concat('${policy.getPolicyLevel()}_${policy.getPolicyName()}_', app_key,'_key')##
#end
#end
###generate rule
#macro( getRule $policy)
#if($policy.getPolicyLevel() == "app")
${policy.getPolicyLevel()}_${policy.getPolicyName()}##
#end
#end
<policy tier="$policy.getPolicyLevel()_$policy.getPolicyName()" level="$policy.getPolicyLevel()" name="#getRule($policy)">
	<eligibilityQuery>
		FROM RequestStream
		SELECT '#getRule($policy)' AS rule, messageID, ( app_tier == '${policy.getPolicyName()}'${condition}) AS isEligible, false as isLocallyThrottled, #getKey() AS throttle_key
		INSERT INTO EligibilityStream;
	</eligibilityQuery>
	<decisionQuery>	
#if($quotaPolicy != "")
		FROM EligibilityStream[isEligible==true AND rule == '#getRule($policy)']#window.time($quotaPolicy.getLimit().getUnitTime() $quotaPolicy.getLimit().getTimeUnit()) 
#if($quotaPolicy.getType() == 'RequestCount')
		select throttle_key, (count(messageID)) >= $quotaPolicy.getLimit().getRequestCount()) as isThrottled 
#else
		select throttle_key, (count(messageID)) >= 1000) as isThrottled #########change {use $quotaPolicy.getLimit().getDataAmount()}
#end
		group by throttle_key
		INSERT ALL EVENTS into ResultStream;
#end
	</decisionQuery>
</policy>
