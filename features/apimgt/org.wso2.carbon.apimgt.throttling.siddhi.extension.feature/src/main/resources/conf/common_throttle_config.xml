<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
 Copyright (c) 2016, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!--
This is the main configuration file for throttling engine. Any change done here will affect
entire throttling flow and misconfigurations will result in undesirable results. Highly advised
not to do any configuration without proper guidance.
-->
<CommonConfig>

	<!--Request stream definition. This is the contract between throttling engine and client on what information should be sent across. -->
	<RequestStream>
		define stream RequestStream (messageID string, app_key string, api_key string, app_tier string, api_tier string, user_id string, properties object);
	</RequestStream>
	<RequestStreamID>org.wso2.throttle.request.stream:1.0.0</RequestStreamID>

	<EligibilityStream>
		define stream EligibilityStream (rule string, messageID string, isEligible bool, isLocallyThrottled bool, throttle_key string);
	</EligibilityStream>

	<ThrottleStream>define stream GlobalThrottleStream (throttle_key string, isThrottled bool);</ThrottleStream>
	<ThrottleStreamID>GlobalThrottleStream:1.0.0</ThrottleStreamID>

	<PreRequestStream>
		define stream PreRequestStream (messageID string, app_key string, api_key string, app_tier string, api_tier string, user_id string, properties string);
	</PreRequestStream>

	<!--Event table definition. This section can be used to configure event table. For more information refer Siddhi documentation.
	https://docs.wso2.com/display/CEP400/SiddhiQL+Guide+3.0#SiddhiQLGuide3.0-EventTable -->
	<EventTable>
		@From(eventtable='sync', bloom.filters = 'enable')
		@IndexBy('throttle_key')
		define table ThrottleTable (throttle_key string);
	</EventTable>

	<!-- Common query running in local throttling component. Any miscofiguration will break the complete throttling flow. -->
	<LocalQuery>
		FROM EligibilityStream[isEligible==false]
		SELECT rule, messageID, false AS isThrottled
		INSERT INTO ThrottleStream;

		FROM EligibilityStream[isEligible==true AND isLocallyThrottled==true]
		SELECT rule, messageID, true AS isThrottled
		INSERT INTO ThrottleStream; 


	</LocalQuery>

	<!-- Common query running in local throttling component. Any miscofiguration will disable throttling and allow access to unlimitted requests. -->
	<GlobalQuery>
		from GlobalThrottleStream[isThrottled==false]
		delete ThrottleTable
		on ThrottleTable.throttle_key==throttle_key;

		from GlobalThrottleStream[isThrottled==true]
		select throttle_key
		insert into ThrottleTable;
	</GlobalQuery>

	<EmittingQuery>
		from ResultStream#throttler:emitOnStateChange(throttle_key, isThrottled)
		select *
		insert into GlobalThrottleStream;
	</EmittingQuery>

	<StreamConversionQuery>
		From PreRequestStream
		select messageID, app_key, api_key, app_tier, api_tier, user_id, map:createFromJSON(properties) as propertiesMap 
		insert into RequestStream;
	</StreamConversionQuery>
</CommonConfig>

