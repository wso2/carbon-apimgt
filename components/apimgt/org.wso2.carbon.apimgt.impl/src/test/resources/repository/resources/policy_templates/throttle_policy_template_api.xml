###################################  macros  #######################################
##
###generate key
#macro( getKey )##
#if($policy.getPolicyLevel() == "api")
#if($policy.getUserLevel() == $ACROSS_ALL)
str:concat('${apiname}_all_','${pipeline}' ,'_key')##
#else
str:concat('${apiname}_per_','${pipeline}_' ,user_id ,'_key')##
#end
#end
#end
###generate rule
#macro( getRule $policy)
#if($policy.getPolicyLevel() == $POLICY_LEVEL_API)
#if($policy.getUserLevel() == $ACROSS_ALL)
${apiname}_all_${pipeline}##
#else
${apiname}_per_${pipeline}##
#end
#end
#end
<policy tier="$policy.getPolicyLevel()_$policy.getPolicyName()" level="$policy.getPolicyLevel()" name="#getRule($policy)">
	<eligibilityQuery>
		FROM RequestStream
		SELECT '#getRule($policy)' AS rule, messageID, ( api_key == '${apicontext}:${apiversion}'$condition ) AS isEligible, false as isLocallyThrottled, #getKey() AS throttle_key
		INSERT INTO EligibilityStream; 
	</eligibilityQuery>
	<decisionQuery>	
#if($quotaPolicy != "")
		FROM EligibilityStream[isEligible==true AND rule == '#getRule($policy)']#window.time($quotaPolicy.getLimit().getUnitTime() $quotaPolicy.getLimit().getTimeUnit()) 
#if($quotaPolicy.getType() == $REQUEST_COUNT_TYPE)
		select throttle_key, (count(messageID) >= $quotaPolicy.getLimit().getRequestCount()) as isThrottled 
#else
		select throttle_key, (count(messageID) >= 1000) as isThrottled #########change {use $quotaPolicy.getLimit().getDataAmount()}
#end		
#if($policy.getUserLevel() == $PER_USER)
		group by throttle_key
#end
		INSERT ALL EVENTS into ResultStream;
#end
	</decisionQuery>
</policy>
